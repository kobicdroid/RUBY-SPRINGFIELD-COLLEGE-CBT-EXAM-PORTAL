<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>RUBY SRINGFIELD COLLEGE - CBT PORTAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #003366; --gold: #FFD700; --bg: #f4f7f9;
            --success: #28a745; --danger: #d9534f; --text: #333;
            --tag-color: #ff9800;
            --admin-sidebar: #1a222b;
            --admin-accent: #3498db;
        }

        /* BLOCK BROWSER DEFAULT PRINTING */
        @media print {
            body { display: none !important; }
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); color: var(--text); user-select: none; overflow-x: hidden; }

        .sumi-brand-footer {
            position: fixed;
            bottom: 20px;
            right: 25px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50px;
            font-size: 11px;
            color: #555;
            z-index: 999999;
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            font-family: 'Segoe UI', sans-serif;
        }
        .sumi-brand-footer strong {
            color: var(--primary);
            font-weight: 800;
            font-size: 13px;
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
        @keyframes scaleCheck { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        .page { display: none; min-height: 100vh; width: 100%; position: absolute; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }

        #help-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 30000; }
        .help-card { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 15px; position: relative; animation: fadeInUp 0.4s; }
        .help-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; font-weight: bold; color: var(--danger); }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9rem; }
        .dot { width: 20px; height: 20px; border-radius: 3px; border: 1px solid #ccc; }

        #fab-help { position: fixed; bottom: 85px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--gold); color: var(--primary); border: 3px solid var(--primary); font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10000; display: none; }

        #submit-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 51, 102, 0.95); color: white; z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; }

        #login-page { display: flex; align-items: center; justify-content: center; background: var(--primary); }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 90%; max-width: 450px; text-align: center; border-top: 8px solid var(--gold); }
        .logo-box { width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }

        #conn-status { font-size: 0.75rem; margin-top: 10px; padding: 5px; border-radius: 4px; display: none; font-weight: bold; }
        .status-online { color: var(--success); background: #e8f5e9; }
        .status-offline { color: var(--danger); background: #ffebee; }
        .status-checking { color: var(--primary); background: #e3f2fd; }

        #instructions-page { background: #eef2f7; display: none; align-items: center; justify-content: center; }
        .instr-container { background: white; max-width: 700px; width: 95%; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: fadeInUp 0.6s ease-out; }
        .instr-header { background: var(--primary); color: white; padding: 25px; text-align: center; }
        .subject-list-container { margin: 20px 0; padding: 0; list-style: none; text-align: left; }
        .subject-item { padding: 10px 15px; margin-bottom: 8px; background: #f8f9fa; border-left: 5px solid var(--gold); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; opacity: 0; animation: fadeInUp 0.5s forwards; }
        .status-pill { font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; background: var(--success); color: white; font-weight: bold; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, var(--primary) 0%, #001a33 100%); color: white; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .security-box { margin-top: 30px; max-width: 500px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; border: 1px solid var(--gold); font-size: 0.9rem; }

        #exam-page { display: none; flex-direction: column; height: 100vh; background: linear-gradient(135deg, #fdfdfd 0%, #eef2f7 50%, #e0e6ed 100%); }
        .info-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 40px; background: rgba(255, 255, 255, 0.9); border-bottom: 2px solid #ddd; }
        #content-wrapper { display: flex; flex-grow: 1; padding: 20px; gap: 20px; overflow-y: auto; justify-content: center; }
        #passage-box { flex: 1; background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; overflow-y: auto; display: none; max-height: 70vh; line-height: 1.7; font-size: 1.05rem; }
        #question-box { flex: 1; max-width: 800px; }
        .q-text { font-size: 1.15rem; line-height: 1.5; margin-bottom: 20px; font-weight: 500; color: #222; }
        .option-item { padding: 12px; border: 1px solid #ddd; margin: 8px 0; border-radius: 5px; cursor: pointer; transition: 0.2s; background: #fdfdfd; }
        .option-item:hover { background: #f0f7ff; border-color: var(--primary); }
        .bottom-nav { background: #f8f9fa; border-top: 1px solid #ddd; padding: 15px 40px; }
        .control-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; align-items: center; }
        
        #calc-box { position: fixed; top: 20%; right: 50px; width: 240px; background: #222; border-radius: 10px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: none; z-index: 2000; }
        #calc-header { padding: 5px; cursor: move; background: #444; margin: -15px -15px 10px -15px; border-radius: 10px 10px 0 0; text-align: center; color: #aaa; font-size: 0.7rem; font-weight: bold; }
        .calc-screen { width: 100%; height: 45px; background: #111; color: #0f0; text-align: right; padding: 10px; font-family: monospace; font-size: 1.2rem; margin-bottom: 10px; border-radius: 5px; box-sizing: border-box; }
        .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .calc-keys button { padding: 10px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }
        .num-key { background: #444; color: white; }
        .op-key { background: var(--primary); color: white; }
        
        #confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 10001; }
        .modal-card { background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px; animation: fadeInUp 0.3s; }
        
        #result-page { background: var(--bg); display: none; align-items: center; justify-content: center; }
        .receipt-card { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 550px; animation: fadeInUp 0.5s; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 8px solid var(--success); }
        .summary-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        
        #final-page { background: white; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100vh; }
        .finish-logo { width: 100px; height: 100px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; animation: scaleCheck 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .finish-logo::after { content: '‚úì'; color: white; font-size: 60px; font-weight: bold; }

        /* --- ADVANCED ADMIN DASHBOARD STYLES --- */
        #admin-page { display: none; background: #f0f2f5; min-height: 100vh; z-index: 1000000; position: relative; padding: 0; }
        .admin-nav { background: var(--admin-sidebar); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .admin-content { padding: 30px; max-width: 1400px; margin: 0 auto; }
        .admin-card { background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 30px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid var(--admin-accent); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-box small { color: #888; text-transform: uppercase; font-size: 0.7rem; font-weight: bold; }
        .stat-box h2 { margin: 5px 0 0 0; color: #333; }

        .admin-search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .admin-search-bar input { margin: 0; flex: 1; border: 1px solid #ddd; padding: 10px 15px; border-radius: 8px; }

        .admin-table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; }
        .admin-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.85rem; }
        .admin-table th { background: #f8f9fa; color: #555; text-align: left; padding: 15px; border-bottom: 2px solid #eee; font-weight: 600; }
        .admin-table td { padding: 15px; border-bottom: 1px solid #eee; color: #444; }
        .admin-table tr:hover { background: #f9fbff; }

        .admin-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; display: inline-block; }
        .badge-auth { background: #e6f4ea; color: #1e7e34; border: 1px solid #b7e1cd; }
        .badge-pending { background: #fff4e5; color: #c87000; border: 1px solid #ffe1bb; }
        
        .action-btn { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: 0.2s; }
        .btn-approve { background: #28a745; color: white; }
        .btn-revoke { background: #ff9800; color: white; }
        .btn-approve:hover, .btn-revoke:hover { opacity: 0.8; transform: translateY(-1px); }

        .admin-refresh-btn { background: var(--admin-accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="sumi-brand-footer" onclick="promptAdmin()">
    <span>Powered by</span>
    <strong>SumiLogic</strong>
</div>

<div id="help-modal">
    <div class="help-card">
        <span class="help-close" onclick="closeHelp()">&times;</span>
        <h3 style="color: var(--primary); margin-top: 0;">Exam Navigation Guide</h3>
        <p style="font-size: 0.9rem; color: #666;">Use the following legend to track your progress:</p>
        <div class="legend-item"><div class="dot" style="background: var(--success);"></div> <span><b>Green:</b> Question Answered & Saved</span></div>
        <div class="legend-item"><div class="dot" style="background: var(--tag-color);"></div> <span><b>Orange:</b> Question Tagged / Skipped</span></div>
        <div class="legend-item"><div class="dot" style="background: white; border: 1px solid #ccc;"></div> <span><b>White:</b> Question Not Yet Visited</span></div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        <ul style="font-size: 0.85rem; padding-left: 20px; line-height: 1.6;">
            <li>Click <b>SAVE & NEXT</b> to move to the next question.</li>
            <li>Click the <b>QUESTION NUMBER</b> in the grid to jump directly to it.</li>
            <li>The exam <b>AUTO-SUBMITS</b> when the timer hits zero.</li>
        </ul>
        <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="closeHelp()">GOT IT, CONTINUE</button>
    </div>
</div>

<button id="fab-help" onclick="openHelp()" title="Help Guide">?</button>

<div id="submit-loader">
    <div style="font-size: 1.5rem; animation: pulse 1.5s infinite;">Finalizing Examination...</div>
    <div style="margin-top: 10px; color: var(--gold);">Uploading data to secure server</div>
</div>

<div id="loading-overlay">
    <div id="loading-spinner" style="font-size: 2rem; animation: pulse 2s infinite;">Initializing Security Protocols...</div>
    <div id="load-subjects-top" style="margin-top:15px; color: var(--gold); font-weight: bold;"></div>
    <div class="security-box">
        <h4 style="color: var(--gold); text-transform: uppercase;">Professional Conduct & Malpractice</h4>
        <ul style="text-align: left; line-height: 1.6;">
            <li>This session is strictly monitored. Tab switching is logged.</li>
            <li>Ensure all external materials are removed from your desk.</li>
            <li>Malpractice will lead to immediate disqualification.</li>
        </ul>
    </div>
</div>

<div id="login-page" class="page" style="display:flex;">
    <div class="login-card">
        <div class="logo-box"><img src="https://cdn-icons-png.flaticon.com/512/3062/3062314.png" width="50"></div>
        <h2 style="margin:0; color:var(--primary)">RUBY SRINGFIELD COLLEGE</h2>
        <h4 id="portal-title" style="margin: 5px 0 25px 0; color: #777; letter-spacing: 1px;">RUBY SRINGFIELD COLLEGE CBT PORTAL</h4>
        
        <div id="auth-fields">
            <input type="text" id="cand-name" placeholder="Full Name (Surname First)">
            <input type="text" id="cand-reg" placeholder="Registration Number">
            <select id="cand-dept" onchange="toggleElectives()">
                <option value="">-- Select Department --</option>
                <option value="SCIENCE HEALTH">SCIENCE (HEALTH)</option>
                <option value="SCIENCE ENGINEERING">SCIENCE (ENGINEERING)</option>
                <option value="HUMANITY">HUMANITY</option>
                <option value="COMMERCIAL">COMMERCIAL</option>
            </select>
            <div id="elective-box" style="display:none;">
                <label id="elective-label" style="font-size: 0.8rem; color: var(--primary); font-weight: bold; display: block; text-align: left; margin-top: 5px;">Choose your 4th Subject:</label>
                <select id="cand-elective"></select>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top: 10px;" onclick="handleLogin()">AUTHENTICATE</button>
            <div id="conn-status"></div>
            <p style="margin-top:20px; font-size:0.9rem;">Already written? <a href="javascript:void(0)" onclick="toggleResultMode(true)" style="color:var(--primary); font-weight:bold; text-decoration:none;">Check Result Slip</a></p>
        </div>

        <div id="result-fields" style="display:none; animation: fadeInUp 0.4s;">
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Enter details to access your authorized result slip.</p>
            <input type="text" id="check-reg" placeholder="Registration Number" style="border: 2px solid var(--primary);">
            <input type="password" id="check-pin" placeholder="4-Digit Access PIN" maxlength="4" style="border: 2px solid var(--success);">
            <button class="btn" style="background:var(--success); color:white; width:100%; margin-top: 10px;" onclick="directToResult()">ACCESS RESULT SLIP</button>
            <p style="margin-top:20px; font-size:0.9rem;"><a href="javascript:void(0)" onclick="toggleResultMode(false)" style="color:var(--text); text-decoration:none;">Back to Exam Login</a></p>
        </div>
    </div>
</div>

<div id="instructions-page" class="page">
    <div class="instr-container">
        <div class="instr-header"><h2 style="margin:0;">PRE-EXAM BRIEFING</h2></div>
        <div class="instr-body" style="padding: 30px;">
            <p><strong>Candidate:</strong> <span id="instr-name"></span></p>
            <p><strong>Reg Number:</strong> <span id="instr-reg" style="color:var(--primary); font-weight:bold;"></span></p>
            <p style="font-size: 0.9rem; color: #666;">Synchronizing registered subjects with central database...</p>
            <div id="subject-list-ui" class="subject-list-container"></div>
            <div id="sync-status" style="margin-top: 15px; padding: 10px; background: #fff8e1; border-radius: 8px; border: 1px solid #ffe082;">
                <p id="sync-text" style="margin: 0; font-size: 0.85rem; color: #856404; text-align: center;">Please wait for all subjects to load...</p>
            </div>
            <button id="start-btn" class="btn btn-primary" style="width:100%; background:var(--success); display: none; margin-top: 15px;" onclick="startExam()">START EXAM</button>
        </div>
    </div>
</div>

<div id="exam-page" class="page">
    <div class="exam-header-top" style="padding: 15px 0 5px 0; background: white; text-align: center;">
        <h2 style="margin:0; color:var(--primary); font-size: 1.4rem; letter-spacing: 1px;">RUBY SRINGFIELD COLLEGE</h2>
    </div>
    <div class="info-bar" id="exam-info-bar">
        <div><small style="color: #888; font-weight: bold; display: block;">CANDIDATE</small><span id="disp-name" style="font-weight: 700; color: var(--primary);"></span></div>
        <div><small style="color: #888; font-weight: bold; display: block;">TIME REMAINING</small><span id="timer" style="font-weight: 900; color: var(--danger); font-size: 1.2rem; font-family: monospace;">02:00:00</span></div>
    </div>
    <div id="sub-tabs" style="display:flex; background:#f0f0f0; border-bottom:1px solid #ccc; flex-wrap: wrap;"></div>
    
    <div id="content-wrapper">
        <div id="passage-box"></div>
        <div id="question-box">
            <div id="q-text" class="q-text"></div>
            <div id="options-box"></div>
        </div>
    </div>

    <div id="calc-box">
        <div id="calc-header">DRAG TO MOVE</div>
        <div class="calc-screen" id="calc-display">0</div>
        <div class="calc-keys">
            <button class="num-key" onclick="cIn('7')">7</button><button class="num-key" onclick="cIn('8')">8</button><button class="num-key" onclick="cIn('9')">9</button><button class="op-key" onclick="cIn('/')">√∑</button>
            <button class="num-key" onclick="cIn('4')">4</button><button class="num-key" onclick="cIn('5')">5</button><button class="num-key" onclick="cIn('6')">6</button><button class="op-key" onclick="cIn('*')">√ó</button>
            <button class="num-key" onclick="cIn('1')">1</button><button class="num-key" onclick="cIn('2')">2</button><button class="num-key" onclick="cIn('3')">3</button><button class="op-key" onclick="cIn('-')">-</button>
            <button class="op-key" style="background:var(--danger);" onclick="cCl()">C</button><button class="num-key" onclick="cIn('0')">0</button><button class="num-key" onclick="cIn('.')">.</button><button class="op-key" onclick="cIn('+')">+</button>
            <button class="op-key" style="grid-column: span 4; background:var(--success);" onclick="cEv()">=</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div id="q-grid" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px;"></div>
        <div class="control-group">
            <button class="btn" style="background:#ddd;" onclick="prevQ()">PREVIOUS</button>
            <button class="btn" style="background:var(--tag-color); color:white;" onclick="tagQuestion()">TAG / SKIP</button>
            <button class="btn btn-primary" onclick="nextQ()">SAVE & NEXT</button>
            <button class="btn" style="background:var(--gold); color:var(--primary);" onclick="tCalc()">üñ© CALCULATOR</button>
            <button class="btn" style="background:var(--danger); color:white;" onclick="showConfirm()">FINISH & SUBMIT</button>
        </div>
    </div>
</div>

<div id="confirm-modal">
    <div class="modal-card">
        <h3>Final Submission</h3>
        <p>Are you sure you want to end your examination?</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="btn" style="background:#ddd;" onclick="hideConfirm()">REVIEW</button>
            <button id="final-submit-btn" class="btn" style="background:var(--success); color:white;" onclick="submitFinal()">CONFIRM SUBMIT</button>
        </div>
    </div>
</div>

<div id="result-page" class="page">
    <div class="receipt-card">
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" width="60">
        </div>
        <h2 style="color:var(--success); text-align:center; margin-top:0;">EXAMINATION COMPLETED</h2>
        <div id="attempt-summary" style="margin-top:25px; border-top: 2px solid #eee;"></div>
        <div style="background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; margin-top: 20px; font-size: 0.85rem; color: #666; text-align: center;">
            Official digital record of performance. Securely stored and validated.
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="goToFinal()">SECURELY PROCEED</button>
    </div>
</div>

<div id="final-page" class="page">
    <div class="finish-logo"></div>
    <h1 style="color: var(--primary); margin: 0;">SUCCESSFULLY SUBMITTED</h1>
    <p style="color: #666; max-width: 450px; margin: 15px 0 10px 0;">
        Student: <strong id="final-cand-name" style="color: #333;"></strong><br>
        Reg No: <strong id="final-cand-reg" style="color: var(--primary);"></strong>
    </p>
    <div id="auth-status-msg" style="width:90%; max-width:400px; margin-bottom: 20px;"></div>
    <div style="display:flex; gap:10px; flex-direction:column; align-items:center;">
        <button id="print-btn" class="btn" style="background: var(--success); color: white; width: 250px;" onclick="checkAuthorizationAndPrint()">
            üñ®Ô∏è CHECK & PRINT RESULT
        </button>
        <button class="btn" style="background: #333; color: white; width: 250px;" onclick="handleLogout()">LOGOUT</button>
    </div>
</div>

<div id="admin-page" class="page">
    <nav class="admin-nav">
        <div style="display:flex; align-items:center; gap:12px;">
            <img src="https://cdn-icons-png.flaticon.com/512/3062/3062314.png" width="30" style="filter: brightness(0) invert(1);">
            <h3 style="margin:0; letter-spacing:1px;">RUBY SRINGFIELD COLLEGE<span style="font-weight:300; opacity:0.7;">ADMIN</span></h3>
        </div>
        <button class="btn" style="background:var(--danger); color:white; padding: 8px 16px;" onclick="window.location.reload()">EXIT PANEL</button>
    </nav>

    <div class="admin-content">
        <div class="stats-grid">
            <div class="stat-box"><small>Total Submissions</small><h2 id="stat-total">0</h2></div>
            <div class="stat-box" style="border-left-color: var(--success);"><small>Authorized Results</small><h2 id="stat-auth">0</h2></div>
            <div class="stat-box" style="border-left-color: var(--tag-color);"><small>Pending Approval</small><h2 id="stat-pending">0</h2></div>
            <div class="stat-box" style="border-left-color: var(--primary);"><small>Avg. Score</small><h2 id="stat-avg">0</h2></div>
        </div>

        <div class="admin-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h4 style="margin:0; color:var(--primary);">CANDIDATE RESULTS DATABASE</h4>
                <button class="admin-refresh-btn" onclick="loadAdminPanel()">üîÑ REFRESH DATA</button>
            </div>
            
            <div class="admin-search-bar">
                <input type="text" id="adminSearch" placeholder="Search by name, reg number or department..." onkeyup="filterAdminTable()">
            </div>

            <div class="admin-table-container">
                <table class="admin-table" id="adminMainTable">
                    <thead>
                        <tr>
                            <th>Reg Number</th>
                            <th>Candidate Name</th>
                            <th>Department</th>
                            <th>Aggregate</th>
                            <th>Security PIN</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body">
                        <tr><td colspan="7" style="text-align:center; padding:40px;">Initializing secure connection...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhrEF3U6BY2f3QMk4Q8-qU9MyrURFA4n-m5gxzxYeUZ0uIoLIU2WjQlkRYg2XmIo9SHw/exec"; 
    
    
    let CANDIDATE_PROFILE = { name: "", reg: "", dept: "" };
    let tabSwitchCount = 0; 

    window.addEventListener('load', async () => {
        const statusBox = document.getElementById('conn-status');
        statusBox.style.display = "block";
        statusBox.innerText = "‚óè PINGING SERVER...";
        statusBox.className = "status-checking";

        try {
            const res = await fetch(SCRIPT_URL + "?action=verify&reg=PING&t=" + Date.now());
            const data = await res.json();
            if(data.status === "online" || data.status === "success") {
                statusBox.innerText = "‚óè SERVER CONNECTED (ONLINE)";
                statusBox.className = "status-online";
            }
        } catch (e) {
            statusBox.innerText = "‚óè CONNECTION FAILED: Check internet or Script Deployment";
            statusBox.className = "status-offline";
        }
    });

    const baseDeptMap = { 
        "SCIENCE HEALTH": ["Use of English", "Physics", "Chemistry", "Biology"], 
        "SCIENCE ENGINEERING": ["Use of English", "Physics", "Chemistry", "Mathematics"], 
        "HUMANITY": ["Use of English", "Government", "Literature"], 
        "COMMERCIAL": ["Use of English", "Accounting", "Mathematics"] 
    };

    let examData = {}, currentSub = "", currentIndex = 0, userAnswers = {}, timeLeft = 120 * 60, isLive = false;
    let taggedQuestions = {}; 
    let candDept = ""; 
    let serverGeneratedPin = "";

    document.addEventListener("visibilitychange", () => {
        if (document.hidden && isLive) {
            tabSwitchCount++;
            alert(`SECURITY WARNING #${tabSwitchCount}: Please do not leave the exam screen. This incident is being logged.`);
            if(tabSwitchCount >= 3) {
                alert("CRITICAL VIOLATION: Excessive tab switching detected. Automatic submission triggered.");
                submitFinal();
            }
        }
    });

    function handleLogout() {
        if (confirm("Are you sure you want to logout? The session will be cleared.")) {
            const reg = document.getElementById('cand-reg').value.trim().toUpperCase();
            if(reg) localStorage.removeItem("cbt_recovery_" + reg);
            tabSwitchCount = 0; 
            window.location.reload();
        }
    }

    function toggleResultMode(isResult) {
        const authFields = document.getElementById('auth-fields');
        const resultFields = document.getElementById('result-fields');
        const title = document.getElementById('portal-title');
        if (isResult) {
            authFields.style.display = 'none';
            resultFields.style.display = 'block';
            title.innerText = "RESULT CHECKING PORTAL";
            title.style.color = "var(--success)";
        } else {
            authFields.style.display = 'block';
            resultFields.style.display = 'none';
            title.innerText = "BARA'IMUL IMAM COLLEGE CBT PORTAL";
            title.style.color = "#777";
        }
    }

    function directToResult() {
        const reg = document.getElementById('check-reg').value.trim();
        const pin = document.getElementById('check-pin').value.trim();
        if (!reg || !pin) return alert("Please enter both Registration Number and PIN");
        
        document.getElementById('auth-status-msg').innerHTML = ""; 

        serverGeneratedPin = pin; 
        CANDIDATE_PROFILE.reg = reg.toUpperCase();
        document.getElementById('final-cand-name').innerText = "Verifying Credentials...";
        document.getElementById('final-cand-reg').innerText = CANDIDATE_PROFILE.reg;
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('final-page').style.display = 'flex';
        checkAuthorizationAndPrint();
    }

    async function checkAuthorizationAndPrint() {
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            alert("The Print Engine is still loading. Please wait a few seconds and try again.");
            return;
        }

        const reg = document.getElementById('final-cand-reg').innerText.toUpperCase().trim();
        const pin = serverGeneratedPin; 
        const btn = document.getElementById('print-btn');
        const msg = document.getElementById('auth-status-msg');
        btn.innerText = "Verifying Authorization...";
        btn.disabled = true;
        try {
            const response = await fetch(`${SCRIPT_URL}?action=checkAuth&reg=${encodeURIComponent(reg)}&pin=${encodeURIComponent(pin)}&t=${Date.now()}`);
            const result = await response.json();
            // SHUTDOWN MOVE: Allow PDF if status is Authorized OR Unauthorized (Immediate release)
            if (result.status === "Authorized" || result.status === "Unauthorized") {
                msg.innerHTML = `<span style="color:var(--success)">Processing Professional Result Slip...</span>`;
                CANDIDATE_PROFILE.name = result.data.name;
                CANDIDATE_PROFILE.reg = result.data.reg;
                document.getElementById('final-cand-name').innerText = CANDIDATE_PROFILE.name;
                let cleanScores = result.data.scores;
                if (typeof cleanScores === 'string') { try { cleanScores = JSON.parse(cleanScores); } catch(e) { cleanScores = {}; } }
                generateProfessionalPDF({
                    name: result.data.name, reg: result.data.reg, dept: result.data.dept, scores: cleanScores, total: result.data.total
                });
                btn.innerText = "RE-PRINT RESULT SLIP";
            } else if (result.status === "WrongPIN") {
                msg.innerHTML = `<span style="color:var(--danger)">ERROR: Incorrect Security PIN. Access Denied.</span>`;
                btn.innerText = "RE-TRY ACCESS";
            } else {
                msg.innerHTML = `<span style="color:var(--danger)">Registration record not found.</span>`;
                btn.innerText = "CHECK & PRINT RESULT";
            }
        } catch (e) { msg.innerText = "Connection Error. Check internet or deployment.";
        } finally { btn.disabled = false; }
    }

    function generateProfessionalPDF(studentData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.7);
        doc.rect(10, 10, pageWidth - 20, pageHeight - 20);

        doc.setFillColor(40, 40, 40); 
        doc.rect(10, 10, pageWidth - 20, 35, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("RUBY SRINGFIELD COLLEGE", pageWidth / 2, 28, { align: "center" });
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("OFFICIAL COMPUTER BASED TEST (CBT) RESULT NOTIFICATION", pageWidth / 2, 38, { align: "center" });

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.text("CANDIDATE INFORMATION", 15, 60);
        doc.line(15, 62, 80, 62);

        doc.setFontSize(10);
        doc.setFont("helvetica", "bold"); doc.text(`FULL NAME:`, 15, 72);
        doc.setFont("helvetica", "normal"); doc.text(`${studentData.name.toUpperCase()}`, 65, 72);
        
        doc.setFont("helvetica", "bold"); doc.text(`REGISTRATION NO:`, 15, 80);
        doc.setFont("helvetica", "normal"); doc.text(`${studentData.reg}`, 65, 80);
        
        doc.setFont("helvetica", "bold"); doc.text(`DEPARTMENT:`, 15, 88);
        doc.setFont("helvetica", "normal"); doc.text(`${studentData.dept.toUpperCase()}`, 65, 88);
        
        doc.setFont("helvetica", "bold"); doc.text(`DATE GENERATED:`, 15, 96);
        doc.setFont("helvetica", "normal"); doc.text(`${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 65, 96);

        const tableBody = Object.entries(studentData.scores).map(([sub, score]) => [
            sub.toUpperCase(), 
            score + "%", 
            score >= 180 ? "EXCELLENT" : score >= 140 ? "CREDIT" : "PASS"
        ]);

        doc.autoTable({
            startY: 105, 
            head: [['SUBJECT TITLE', 'SCORE', 'REMARK']], 
            body: tableBody, 
            theme: 'grid',
            headStyles: { fillColor: [60, 60, 60], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center' },
            styles: { fontSize: 10, cellPadding: 6, textColor: [0, 0, 0], lineColor: [0, 0, 0] },
            columnStyles: { 1: { halign: 'center' }, 2: { halign: 'center' } },
            foot: [[ 
                { content: 'AGGREGATE PERFORMANCE SCORE', colSpan: 1, styles: { fontStyle: 'bold', fillColor: [240, 240, 240] } }, 
                { content: studentData.total, styles: { fontStyle: 'bold', halign: 'center', fontSize: 13, fillColor: [240, 240, 240] } }, 
                { content: 'CBT CERTIFIED', styles: { fontStyle: 'bold', halign: 'center', fillColor: [240, 240, 240] } } 
            ]]
        });

        let finalY = doc.lastAutoTable.finalY + 40;
        if (finalY > 260) { doc.addPage(); finalY = 40; }

        doc.setDrawColor(0, 0, 0);
        doc.line(130, finalY, 190, finalY);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        doc.text("EXAMINATION DIRECTOR SIGNATURE", 160, finalY + 7, { align: "center" });
        doc.setFontSize(7);
        doc.setFont("helvetica", "italic");
        doc.text("System Validated Digital Record", 160, finalY + 11, { align: "center" });

        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        const footerText = "This result slip is an official document of RUBY SRINGFIELD COLLEGE. Any alteration renders it void. Verification can be performed via the central CBT administration portal.";
        const splitFooter = doc.splitTextToSize(footerText, pageWidth - 40);
        doc.text(splitFooter, pageWidth / 2, pageHeight - 18, { align: "center" });
        doc.text("Powered by SumiLogic CBT Engine", pageWidth / 2, pageHeight - 13, { align: "center" });

        // SHUTDOWN MOVE: Improved blob-trigger for APK/Mobile permissions
        try {
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const downloadLink = document.createElement("a");
            downloadLink.href = pdfUrl;
            downloadLink.download = `CBT_Result_${studentData.reg}.pdf`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(pdfUrl);
        } catch (e) {
            doc.save(`CBT_Result_${studentData.reg}.pdf`);
        }
    }

    function saveProgress() {
        if (!isLive) return;
        const state = { userAnswers, taggedQuestions, timeLeft, currentSub, currentIndex, profile: CANDIDATE_PROFILE, tabSwitches: tabSwitchCount, examData };
        localStorage.setItem("cbt_recovery_" + CANDIDATE_PROFILE.reg, JSON.stringify(state));
    }

    function checkRecovery(reg) {
        const saved = localStorage.getItem("cbt_recovery_" + reg.toUpperCase().trim());
        return saved ? JSON.parse(saved) : null;
    }

    window.onbeforeunload = function() { if (isLive) return "Exam in progress!"; };
    function openHelp() { document.getElementById('help-modal').style.display = 'flex'; }
    function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }
    function hideConfirm() { document.getElementById('confirm-modal').style.display = 'none'; }
    function showConfirm() { document.getElementById('confirm-modal').style.display = 'flex'; }
    function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

    function toggleElectives() {
        const dept = document.getElementById('cand-dept').value;
        const box = document.getElementById('elective-box');
        const sel = document.getElementById('cand-elective');
        if(dept === "HUMANITY") { 
            box.style.display = 'block'; 
            sel.innerHTML = '<option value="">-- Select 4th Subject --</option><option value="IRK">IRK</option><option value="CRS">CRS</option><option value="Economics">Economics</option>'; 
        } else if(dept === "COMMERCIAL") { 
            box.style.display = 'block'; 
            sel.innerHTML = '<option value="">-- Select 4th Subject --</option><option value="Commerce">Commerce</option><option value="History">History</option>'; 
        } else { box.style.display = 'none'; }
    }

    async function handleLogin() {
        const nameInput = document.getElementById('cand-name').value.trim();
        const reg = document.getElementById('cand-reg').value.trim().toUpperCase();
        const dept = document.getElementById('cand-dept').value;
        const elective = document.getElementById('cand-elective').value;
        if(!nameInput || !reg || !dept) return alert("Please enter all details");
        candDept = dept; 
        document.getElementById('loading-overlay').style.display = 'flex';
        document.getElementById('load-subjects-top').innerText = "Authenticating Registration...";
        try {
            const authCheck = await fetch(`${SCRIPT_URL}?action=verify&reg=${encodeURIComponent(reg)}&t=${Date.now()}`);
            const authStatus = await authCheck.json();
            
            if (authStatus.status === "error") { 
                document.getElementById('loading-overlay').style.display = 'none'; 
                return alert("ACCESS DENIED: " + authStatus.message); 
            }
            // SHUTDOWN MOVE: Removed "submitted: true" check to allow multiple exam attempts

            CANDIDATE_PROFILE.name = (authStatus.name && authStatus.name !== "CANDIDATE") ? authStatus.name.toUpperCase() : nameInput.toUpperCase();
            CANDIDATE_PROFILE.reg = reg;
            CANDIDATE_PROFILE.dept = dept;

            let subs = [...baseDeptMap[dept]];
            if(elective && elective !== "") subs.push(elective);
            const recoveryData = checkRecovery(reg);
            examData = {}; 

            const promises = subs.map(s => fetch(`${SCRIPT_URL}?subject=${encodeURIComponent(s.trim())}`).then(res => res.json()).then(data => {
                if(!data || data.length === 0) return;
                
                if (recoveryData && recoveryData.examData && recoveryData.examData[s]) {
                    examData[s] = recoveryData.examData[s];
                } else {
                    let shuffledPool = shuffle([...data]);
                    let limit = (s.toLowerCase().includes("english")) ? 60 : 40;
                    examData[s] = shuffledPool.slice(0, limit);
                }

                userAnswers[s] = recoveryData ? (recoveryData.userAnswers[s] || new Array(examData[s].length).fill(null)) : new Array(examData[s].length).fill(null);
                taggedQuestions[s] = recoveryData ? (recoveryData.taggedQuestions[s] || new Array(examData[s].length).fill(false)) : new Array(examData[s].length).fill(false);
            }));

            await Promise.all(promises);
            if(recoveryData) { timeLeft = recoveryData.timeLeft; currentSub = recoveryData.currentSub; currentIndex = recoveryData.currentIndex; tabSwitchCount = recoveryData.tabSwitches || 0; }
            document.getElementById('instr-name').innerText = CANDIDATE_PROFILE.name;
            document.getElementById('instr-reg').innerText = CANDIDATE_PROFILE.reg;
            document.getElementById('disp-name').innerText = CANDIDATE_PROFILE.name;
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('instructions-page').style.display = 'flex';
            const listUI = document.getElementById('subject-list-ui'); listUI.innerHTML = "";
            Object.keys(examData).forEach((s) => { const item = document.createElement('li'); item.className = 'subject-item'; item.innerHTML = `<span>${s} (${examData[s].length} Qs)</span><span class="status-pill">LOADED ‚úì</span>`; listUI.appendChild(item); });
            document.getElementById('start-btn').style.display = "block"; 
        } catch(e) { console.error(e); document.getElementById('loading-overlay').style.display = 'none'; alert("CONNECTION ERROR: The server did not respond."); }
    }

    function startExam() { 
        if(Object.keys(examData).length === 0) return alert("Error: Questions not loaded properly.");
        isLive = true; 
        document.getElementById('instructions-page').style.display = 'none'; 
        document.getElementById('exam-page').style.display = 'flex'; 
        document.getElementById('fab-help').style.display = 'block'; 
        const tabs = document.getElementById('sub-tabs'); tabs.innerHTML = "";
        Object.keys(examData).forEach(s => { const t = document.createElement('div'); t.innerText = s; t.style.padding = "12px 20px"; t.style.cursor = "pointer"; t.style.fontWeight = "bold"; t.onclick = () => switchSub(s); tabs.appendChild(t); });
        if(!currentSub) currentSub = Object.keys(examData)[0];
        switchSub(currentSub); startTimer(); 
    }

    function switchSub(s) { currentSub = s; currentIndex = 0; document.querySelectorAll('#sub-tabs div').forEach(t => t.style.borderBottom = (t.innerText === s) ? "3px solid var(--primary)" : "none"); loadQ(); renderGrid(); }

    function loadQ() {
        if(!examData[currentSub] || !examData[currentSub][currentIndex]) return;
        const q = examData[currentSub][currentIndex]; 
        const passageBox = document.getElementById('passage-box');
        const questionText = q.q || q.question || q.Question || "Question content missing";
        const passageText = q.passage || q.Passage || "";
        if (passageText && passageText.trim() !== "") { passageBox.innerHTML = `<strong>PASSAGE:</strong><br>${passageText}`; passageBox.style.display = 'block'; } else { passageBox.style.display = 'none'; }
        document.getElementById('q-text').innerHTML = `(${currentIndex + 1}) ${questionText}`;
        const box = document.getElementById('options-box'); box.innerHTML = '';
        ['a','b','c','d'].forEach(opt => {
            const isSelected = userAnswers[currentSub][currentIndex] === opt.toUpperCase();
            const div = document.createElement('div'); div.className = 'option-item';
            if(isSelected) { div.style.borderColor = 'var(--primary)'; div.style.background = '#f0f7ff'; }
            const optionContent = q[opt] || q[opt.toUpperCase()] || "Option missing";
            div.innerHTML = `<input type="radio" ${isSelected ? 'checked' : ''}> ${optionContent}`;
            div.onclick = () => { userAnswers[currentSub][currentIndex] = opt.toUpperCase(); taggedQuestions[currentSub][currentIndex] = false; saveProgress(); renderGrid(); loadQ(); };
            box.appendChild(div);
        });
        if (window.MathJax && window.MathJax.typeset) { MathJax.typeset(); }
    }

    function renderGrid() {
        if(!examData[currentSub]) return;
        const g = document.getElementById('q-grid'); g.innerHTML = '';
        examData[currentSub].forEach((_, i) => {
            const b = document.createElement('div'); b.style.width="30px"; b.style.height="30px"; b.style.display="flex"; b.style.alignItems="center"; b.style.justifyContent="center"; b.style.cursor="pointer"; b.style.border="1px solid #ccc";
            if (taggedQuestions[currentSub][i]) { b.style.background = "var(--tag-color)"; b.style.color = "white"; }
            else if (userAnswers[currentSub][i]) { b.style.background = "var(--success)"; b.style.color = "white"; }
            else { b.style.background = "white"; }
            b.innerText = i+1; b.onclick = () => { currentIndex = i; loadQ(); }; g.appendChild(b);
        });
    }

    function nextQ() { if(currentIndex < examData[currentSub].length -1) { currentIndex++; loadQ(); renderGrid(); saveProgress(); } }
    function prevQ() { if(currentIndex > 0) { currentIndex--; loadQ(); renderGrid(); saveProgress(); } }
    function tagQuestion() { taggedQuestions[currentSub][currentIndex] = true; saveProgress(); nextQ(); }

    function startTimer() { 
        setInterval(() => { if(!isLive || timeLeft <= 0) return; timeLeft--; if(timeLeft % 10 === 0) saveProgress(); let h = Math.floor(timeLeft / 3600), m = Math.floor((timeLeft % 3600) / 60), s = timeLeft % 60;
            const timerEl = document.getElementById('timer'); timerEl.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(timeLeft < 900) { timerEl.style.color = "var(--danger)"; timerEl.style.animation = "pulse 1s infinite"; } if(timeLeft === 0) submitFinal();
        }, 1000); 
    }

    async function submitFinal() {
        isLive = false; 
        document.getElementById('confirm-modal').style.display = 'none'; 
        document.getElementById('submit-loader').style.display = 'flex';
        
        let finalScores = {}, aggregateTotal = 0, summaryHtml = "<h4>CANDIDATE ATTEMPT BREAKDOWN:</h4>";
        Object.keys(examData).forEach(subject => {
            let correct = 0, attempted = 0, totalQs = examData[subject].length;
            examData[subject].forEach((q, idx) => { if (userAnswers[subject][idx]) attempted++; const correctAnswer = (q.ans || q.answer || q.Correct || "").toString().trim().toUpperCase(); if (userAnswers[subject][idx] === correctAnswer) correct++; });
            let scaled = Math.round((correct / totalQs) * 100); finalScores[subject] = scaled; aggregateTotal += scaled;
            summaryHtml += `<div class="summary-row"><span>${subject} (${totalQs} Qs)</span><span>Raw: ${correct} | <b>Scaled: ${scaled}</b></span></div>`;
        });

        const payload = { name: CANDIDATE_PROFILE.name, reg: CANDIDATE_PROFILE.reg, dept: CANDIDATE_PROFILE.dept, scores: finalScores, total: aggregateTotal, tabSwitches: tabSwitchCount };

        try {
            const response = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            const result = await response.json(); 
            serverGeneratedPin = result.pin;
            localStorage.removeItem("cbt_recovery_" + CANDIDATE_PROFILE.reg);
            
            document.getElementById('submit-loader').style.display = 'none'; 
            document.getElementById('exam-page').style.display = 'none';
            document.getElementById('result-page').style.display = 'flex'; 

            // SHUTDOWN MOVE: Professional Score Dashboard Display
            let scoreDashboard = `
                <div style="background:var(--primary); color:white; padding:25px; border-radius:15px; text-align:center; margin-bottom:25px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
                    <small style="text-transform:uppercase; letter-spacing:1.5px; opacity:0.8; font-weight:bold;">Aggregate Performance Score</small>
                    <h1 style="font-size:3.5rem; margin:10px 0; font-family: 'Segoe UI Black', sans-serif;">${aggregateTotal}</h1>
                    <div style="height:3px; background:var(--gold); width:60px; margin:15px auto;"></div>
                    <p style="font-size:0.9rem; margin:0; opacity:0.9;">System Status: Examination Record Logged Successfully</p>
                </div>
                ${summaryHtml}
            `;
            document.getElementById('attempt-summary').innerHTML = scoreDashboard;
        } catch(e) { 
            alert("SUBMISSION ERROR. Please inform the supervisor."); 
            document.getElementById('submit-loader').style.display = 'none'; 
        }
    }

    function goToFinal() {
        document.getElementById('result-page').style.display = 'none'; document.getElementById('final-page').style.display = 'flex';
        document.getElementById('final-cand-name').innerText = CANDIDATE_PROFILE.name; document.getElementById('final-cand-reg').innerText = CANDIDATE_PROFILE.reg;
        const pin = serverGeneratedPin || "####";
        document.getElementById('auth-status-msg').innerHTML = `
            <div style="background: #f8f9fa; border: 2px solid #333; padding: 20px; border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center;">
                <p style="margin: 0; color: #333; font-size: 0.85rem; font-weight: bold; text-transform: uppercase;">Result Access PIN</p>
                <h2 id="pin-display" style="margin: 10px 0; color: #000; letter-spacing: 8px; font-size: 2.5rem;">${pin}</h2>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                    <button onclick="copyPinToClipboard('${pin}')" id="copy-btn" class="btn" style="background: #333; color: white; padding: 8px 15px; font-size: 0.8rem; border-radius: 5px;">üìã COPY PIN</button>
                    <button onclick="downloadCredentials('${CANDIDATE_PROFILE.reg}', '${pin}')" class="btn" style="background: #003366; color: white; padding: 8px 15px; font-size: 0.8rem; border-radius: 5px;">üíæ SAVE AS FILE</button>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 0.75rem; line-height: 1.4;"><strong>IMPORTANT:</strong> You need this PIN and your Reg No to access/print your result slip later.</p>
            </div>
        `;
        copyPinToClipboard(pin, true);
    }

    function copyPinToClipboard(pin, silent = false) { navigator.clipboard.writeText(pin).then(() => { if (!silent) { const btn = document.getElementById('copy-btn'); btn.innerHTML = "‚úÖ COPIED!"; setTimeout(() => btn.innerHTML = "üìã COPY PIN", 2000); } }); }
    function downloadCredentials(reg, pin) { const text = `RUBY SRINGFIELD COLLEGE - CBT PORTAL\n\nSTUDENT: ${CANDIDATE_PROFILE.name}\nREG NO: ${reg}\nACCESS PIN: ${pin}\n\nUse these credentials to access and print your result slip.`; const blob = new Blob([text], { type: 'text/plain' }); const anchor = document.createElement('a'); anchor.download = `CBT_Credentials_${reg}.txt`; anchor.href = window.URL.createObjectURL(blob); anchor.click(); }

    function promptAdmin() { const pass = prompt("Enter Administration Password:"); if (pass === "SUMI") { loadAdminPanel(); } else if (pass) { alert("Unauthorized Access Attempt Logged."); } }

    async function loadAdminPanel() {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById('admin-page').style.display = 'block';
        const tbody = document.getElementById('admin-table-body');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 40px;">Synchronizing with secure cloud database...</td></tr>';
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getResults&t=${Date.now()}`);
            const data = await res.json();
            
            let authCount = 0, pendingCount = 0, totalScore = 0;
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const isAuth = row.Status === "Authorized";
                if(isAuth) authCount++; else pendingCount++;
                totalScore += parseFloat(row.Total) || 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold; color:var(--primary)">${row.RegNo}</td>
                    <td>${row.Name}</td>
                    <td>${row.Dept}</td>
                    <td><b style="font-size:1rem">${row.Total}</b></td>
                    <td><code>${row.PIN}</code></td>
                    <td><span class="admin-badge ${isAuth ? 'badge-auth' : 'badge-pending'}">${row.Status}</span></td>
                    <td>
                        <button onclick="updateStatus('${row.RegNo}', '${isAuth ? 'Unauthorized' : 'Authorized'}')" 
                                class="action-btn ${isAuth ? 'btn-revoke' : 'btn-approve'}">
                            ${isAuth ? 'Revoke' : 'Authorize'}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('stat-total').innerText = data.length;
            document.getElementById('stat-auth').innerText = authCount;
            document.getElementById('stat-pending').innerText = pendingCount;
            document.getElementById('stat-avg').innerText = data.length ? Math.round(totalScore/data.length) : 0;

        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red; padding:40px;">CRITICAL: Connection to database failed.</td></tr>';
        }
    }

    function filterAdminTable() {
        const input = document.getElementById("adminSearch").value.toUpperCase();
        const rows = document.getElementById("admin-table-body").getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
            const text = rows[i].textContent || rows[i].innerText;
            rows[i].style.display = text.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }

    async function updateStatus(reg, newStatus) {
        if(!confirm(`Update security status for ${reg} to ${newStatus}?`)) return;
        try {
            await fetch(`${SCRIPT_URL}?action=updateStatus&reg=${reg}&status=${newStatus}`);
            loadAdminPanel();
        } catch (e) { alert("Status update failed."); }
    }

    dragElement(document.getElementById("calc-box"));
    function dragElement(e){var n=0,t=0,o=0,l=0;function r(e){(e=e||window.event).preventDefault();o=e.clientX;l=e.clientY;document.onmouseup=u;document.onmousemove=i}function i(r){(r=r||window.event).preventDefault();n=o-r.clientX;t=l-r.clientY;o=r.clientX;l=r.clientY;e.style.top=e.offsetTop-t+"px";e.style.left=e.offsetLeft-n+"px"}function u(){document.onmouseup=null;document.onmousemove=null}document.getElementById(e.id+"-header")?document.getElementById(e.id+"-header").onmousedown=r:e.onmousedown=r}
    let cV = ""; function tCalc() { const b = document.getElementById('calc-box'); b.style.display = (b.style.display==='block')?'none':'block'; }
    function cIn(v) { cV += v; document.getElementById('calc-display').innerText = cV; } function cCl() { cV = ""; document.getElementById('calc-display').innerText = "0"; }
    function cEv() { try { cV = eval(cV).toString(); document.getElementById('calc-display').innerText = cV; } catch { cCl(); } }
</script>
</body>
</html>

